# Домашнее задание к занятию 17 «Инцидент-менеджмент»

- [краткое описание на русском языке](https://habr.com/ru/post/427301/)
- [развёрнутое описание на английском языке](https://github.blog/2018-10-30-oct21-post-incident-analysis/)

## Краткое описание инцидента

При попытке создания **Issue** и записи комментариев к уже существующим — запись/комментарий визуально отображались, а после обновления страницы пропадали.

## Предшествующие события

Плановые работы по замене вышедшего из строя оптического оборудования 100G привели к потере связи между сетевым узлом и основным центром обработки данных. Связь между этими точками была восстановлена ​​за 43 секунды.

## Причина инцидента

Отсутствие консистентности данных между двумя ЦОД.

В момент потери соединения между двумя центрами данных, второстепенный ЦОД смог установить кворум с компонентом [Orchestrator](https://github.com/github/orchestrator) (используется для управления кластеров БД и переключением ролей кластеров между ЦОД). Таким образом второстепенный ЦОД, а точнее кластер БД в нем, стал основным, но при этом в нем отсутствовала часть данных из бывшего основного кластера. Это привело к невозможности последнего перейти в режим репликации.

## Воздействие

Деградация доступности всего сервиса, а также полностью приостановленные доставки Webhook'ов и сборки GitHub Pages.

## Обнаружение

Внутренние системы мониторинга начали генерировать оповещения, указывающие на то, что системы испытывают многочисленные сбои.

## Реакция

Инженеры первой группы реагирования выявили, что топологии для многочисленных кластеров баз данных находятся в не соответствующем состоянии.

## Восстановление

Для защиты целостности пользовательских данных, было принято решение восстанавливать БД из резервной копии с последующей синхронизацией реплики.

## Таймлайн

> 21.11.2018 22:52 - смена роли кластера БД.

> 21.11.2018 22:54 - обнаружение проблемы.

> 21.11.2018 23:07 - блокировка внутренних систем развертывания, сайт вначале переведен в желтый, а за тем в красный статус.

> 21.11.2018 23:13 - принятие решения о начале восстановление БД из резервной копии.

> 21.11.2018 23:19 - полностью приостановлены доставки Webhook'ов и сборки GitHub Pages.

> 22.11.2018 00:05 - формирования плана по устранению несоответствий данных и внедрению процедур отказоустойчивости.

> 22.11.2018 00:41 - запущен процесс восстановления из резервной копии.

> 22.11.2018 06:51 - несколько кластеров завершили восстановление из резервной копии в  ЦОД 1 и начали реплицировать новые данные с ЦОД 2.

> 22.11.2018 07:46 - опубликовал запись в блоге.

> 22.11.2018 11:12 - все основные БД  восстановлены в ЦОД 1, но все еще оставались десятки реплик, которые отставали от на несколько часов.

> 22.11.2018 13:15 - уменьшение количества реплик, позволила сократить отставание.

> 22.11.2018 16:24 - выполнено аварийное переключение на исходную топологию.

> 22.11.2018 16:45 - возобновлены доставки Webhook'ов и сборки GitHub Pages.

> 22.11.2018 23:03 - статус сайта был обновлен до зеленого.

## Последующие действия

После восстановление провести анализ не консистентных данных, которые были созданы пользователями в момент потери связи между ЦОД. И обработать (записать данные в БД) в "ручном" режиме. 

Улучшение коммуникаций с пользовтелями и предоставления им более точной и своевременной информации об инцидентах.

Технические изменения: измените конфигурации Orchestrator, новый механизм отчетности о состоянии всех компонентов сервиса (ранее информация была обобщенная и касалась о состоянии сайта в целом), инициатива архитектурных изменений, которая позволит выдержать полный отказ одного ЦОД без воздействия на пользователя.

Внедрение системной практики проверки сценариев сбоев и инвестиции в хаос-инжиниринг.
